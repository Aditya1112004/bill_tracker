<% const uniqueDebtors = [...new Set(advancePayment.map(entry => entry.debtors))]; %>
<%
function parseDMY(dateStr) {
  if (!dateStr) return new Date('Invalid');
  if (typeof dateStr === 'number') return new Date((dateStr - 25569) * 86400 * 1000); // Excel serial
  if (dateStr.includes('-')) {
    const [dd, mm, yyyy] = dateStr.split('-');
    return new Date(`${yyyy}-${mm}-${dd}`);
  }
  return new Date(dateStr);
}
function daysBetweenToday(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return '-';
  const today = new Date();
  today.setHours(0,0,0,0);
  d.setHours(0,0,0,0);
  return Math.floor((today - d) / (1000 * 60 * 60 * 24));
}
let totalBill = 0, totalReceived = 0, totalTds = 0, totalPending = 0, totalPaid = 0;
advancePayment.sort((a, b) => parseDMY(a.date) - parseDMY(b.date)).forEach(entry => {
  const bill = Number(entry.bill_amount) || 0;
  const received = Number(entry.received) || 0;
  const paid = Number(entry.paid_amount) || 0;
  const tds = Number(entry.tds) || 0;
  totalBill += bill;
  totalReceived += received;
  totalPaid += paid;
  totalTds += tds;
  totalPending += (bill - received - tds);
}); %>
<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advance Payment</title>
  <link rel="stylesheet" href="/style.css">
  <script>
    function filterTable() {
      var input = document.getElementById('searchInput');
      var filter = input.value.toLowerCase();
      var table = document.getElementById('salesTable');
      var trs = table.getElementsByTagName('tr');
      for (var i = 1; i < trs.length; i++) {
        var td = trs[i].getElementsByTagName('td')[0];
        if (td) {
          var txtValue = td.textContent || td.innerText;
          trs[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? '' : 'none';
        }
      }
    }
    function toggleEditForm(id) {
      var form = document.getElementById('edit-form-' + id);
      form.style.display = form.style.display === 'none' ? 'table-row' : 'none';
    }
    function closeEditForm(id) {
      var form = document.getElementById('edit-form-' + id);
      form.style.display = 'none';
    }
    
  </script>
</head>
<body>
  <a href="/" style="position: absolute; left: 20px; top: 10px; text-decoration: none; font-size: 18px;">&larr; Back</a>
  <button onclick="window.location.reload()" title="Reload" style="position: absolute; right: 30px; top: 18px; background: #fff; border: none; border-radius: 50%; box-shadow: 0 2px 8px rgba(34,34,59,0.10); width: 38px; height: 38px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #3a86ff; transition: background 0.2s;">
    &#x21bb;
  </button>
  <h1>ADVANCE PAYMENTS</h1>
  <a href="/advance_payment/excel/preview" target="_blank"><button class="excel-btn" style="font-size: 16px; margin-bottom: 14px;">Preview Excel</button></a>
  <div id="new-entry-form" style="display:block; margin-bottom: 14px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(34,34,59,0.08); padding: 4px 16px; max-width: 1200px; margin-left:auto; margin-right:auto;">
    <form action="/advance_payment/new" method="post" style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; justify-content: center;">
      <input name="debtors" list="debtors-list" placeholder="Party Name" required style="flex:1; min-width:120px;">
      <datalist id="debtors-list">
        <% uniqueDebtors.forEach(debtor => { %>
          <option value="<%= debtor %>"></option>
        <% }); %>
      </datalist>
      <input id="new-date" name="date" type="date" required style="flex:1; min-width:120px;">
      <input name="bill_amount" type="number" step="0.01" placeholder="Received Amount" required style="flex:1; min-width:120px;">
      <input name="paid_amount" type="number" step="0.01" placeholder="Paid Amount" required style="flex:1; min-width:120px;">
      <input name="review" placeholder="Remark" style="flex:1; min-width:120px;">
      <button class="new-entry-btn" type="submit" style="width: 70px; height: 30px; font-size: 16px; padding: 0px;"> Save </button>
      <!-- <button type="button" onclick="toggleNewEntryForm()">Cancel</button> -->
    </form>
  </div>
  <div style="width:90%;margin:0 auto;">
    <div style="background:#e7f0fd; font-weight:bold; border-radius:8px; display:flex; justify-content:space-around; align-items:center; padding:10px 20px; margin-bottom:4px;">
      <span></span>
      <span style="background-color: #e27a2b; padding: 5px 10px; border-radius: 5px; color: #fff; font-weight:bold; margin: 0 10px; font-size: 18px;">Total Paid: <%= totalPaid %></span>
      <span style="background-color: #29a10e; padding: 5px 10px; border-radius: 5px; color: #fff; font-weight:bold; margin: 0 10px;font-size: 18px;">Total Received: <%= totalBill %></span>
      <span></span>
    </div>
  </div>
  <table id="salesTable" border="1" style="border-collapse: collapse; width: 90%; margin: 0 auto;">
    <thead>
      <tr>
        <th>Party Name</th>
        <th>Date</th>
        <th>Received Amt.</th>
        <th>Paid Amt.</th>
        <th>Remark</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>

      <% advancePayment.sort((a, b) => daysBetweenToday(b.date) - daysBetweenToday(a.date)).forEach(entry => { %>
        <tr>
          <td><%= entry.debtors %></td>
          <td><%= entry.date %></td>
          <td><%= Number(entry.bill_amount) %></td>
          <td><%= Number(entry.paid_amount) %></td>
          <td><%= entry.review %></td>
          <td>
            <button type="button" onclick="toggleEditForm(<%= entry.id %>)">Edit</button>
            <form action="/advance_payment/delete/<%= entry.id %>" method="POST" style="display:inline;">
              <button class="delete-btn" type="submit" onclick="return confirm('Are you sure you want to delete this entry?');">Delete</button>
            </form>
          </td>
        </tr>
        <tr id="edit-form-<%= entry.id %>" style="display:none; background:#f4f6fb;">
          <td colspan="9">
            <form action="/advance_payment/edit/<%= entry.id %>" method="post" style="display: flex; flex-wrap: wrap; gap: 1px; align-items: center; justify-content: center;">
              <input class='edit-form-input ' name="debtors" value="<%= entry.debtors %>"  style="flex:1; min-width:50px;">
              <input class='edit-form-input ' name="date" type="date" value="<%= entry.date %>"  style="flex:1; min-width:50px;">
              <input class='edit-form-input ' name="bill_amount" type="number" step="0.01" value="<%= Number(entry.bill_amount) %>"  style="flex:1; min-width:50px;">
              <input class='edit-form-input ' name="paid_amount" type="number" step="0.01" value="<%= Number(entry.paid_amount) %>"  style="flex:1; min-width:50px;">
              <input class='edit-form-input ' name="review" value="<%= entry.review %>" style="flex:1; min-width:50px;">
              <button class="new-entry-btn" type="submit">Save</button>
              <button type="button" onclick="closeEditForm(<%= entry.id %>)">Cancel</button>
            </form>
          </td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</body>
</html> 